name: Clear History

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "CLEAR" to confirm'
        required: true
        type: string

jobs:
  clear-history:
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate confirmation (manual trigger only)
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "CLEAR" ]; then
            echo "âŒ Confirmation failed. Please type 'CLEAR' to proceed."
            exit 1
          fi
          echo "âœ… Confirmation validated"
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Clear history.json
        id: clear
        run: |
          echo "ðŸ—‘ï¸ Clearing history.json..."
          
          # Check if history.json exists
          if [ ! -f "history.json" ]; then
            echo "âŒ history.json not found"
            exit 1
          fi
          
          # Get current item count
          ITEMS_BEFORE=$(jq 'length' history.json 2>/dev/null || echo 0)
          echo "ðŸ“Š Items before: $ITEMS_BEFORE"
          
          # Clear history (empty array)
          echo "[]" > history.json
          
          # Update last-clear.json
          TIMESTAMP=$(date +%s)000
          echo "{\"lastClearTimestamp\": $TIMESTAMP}" > last-clear.json
          
          # Generate date tag
          DATE_TAG=$(date -u '+%d%m%Y')
          
          echo "âœ… History cleared!"
          echo "ITEMS_REMOVED=$ITEMS_BEFORE" >> $GITHUB_OUTPUT
          echo "DATE_TAG=$DATE_TAG" >> $GITHUB_OUTPUT
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add history.json last-clear.json
          git commit -m "ðŸ—‘ï¸ [${{ steps.clear.outputs.DATE_TAG }}] Clear history (daily reset) [skip ci]"
          git push
          
          echo "âœ… Changes committed and pushed"
      
      - name: Summary
        run: |
          echo "### ðŸ—‘ï¸ History Cleared" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Items removed:** ${{ steps.clear.outputs.ITEMS_REMOVED }}" >> $GITHUB_STEP_SUMMARY
